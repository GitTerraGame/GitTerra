<html>
  <head>
    <style>
      h1,
      #feedback {
        text-align: center;
      }

      h1 * {
        vertical-align: middle;
      }
      body {
        background: url("images/background_and_menus/site_background_image_bg.svg");
        background-size: cover;
      }

      #mainMenu {
        background-color: #2e3192;
        border: 3px solid white;
        padding: 20% 20px;
        margin-top: -15%;
        z-index: -100;
        margin-left: 5%;
        margin-right: 5%;
      }

      #wholeMenu {
        left: 50%;
        margin-right: -50%;
        transform: translate(-50%, 0);
        position: absolute;
        width: 30%;
      }
      #inputField {
        display: block;
        margin: 1px auto 12% auto;
        width: 100%;
        border: 2px solid rgb(19, 4, 77);
        font-size: 1.2em;
        line-height: 2.5em;
      }
      *:focus {
        outline: 0 !important;
      }
      #error {
        display: none;
        text-align: center;
        color: red;
      }
    </style>
  </head>

  <body>
    <div id="wholeMenu">
      <img id="logobanner" src="images/background_and_menus/logobanner.svg" />

      <div id="mainMenu">
        <img
          id="enterGitRepo"
          src="images/background_and_menus/home_page_enterGitRepo.svg"
        />
        <input type="text" id="inputField" name="inputField" />
        <div id="error"></div>
        <input
          type="image"
          id="generateButton"
          alt="Submit"
          src="images/background_and_menus/home_page_generateButton.svg"
          onclick="processInput()"
        />
      </div>

      <div id="feedback">
        <a
          href="https://github.com/GitTerraGame/GitTerra/issues/new?template=feedback.md&labels=feedback"
          >How can we make this game better?</a
        >
      </div>
    </div>
    <script>
      async function processInput() {
        const body = document.querySelector("body");

        if (!validateInput()) {
          return;
        }
        const repo = { repo: document.getElementById("inputField").value };
        try {
          let response = await fetch("/api/generateMap", {
            method: "POST",
            body: JSON.stringify(repo),
            headers: { "Content-type": "application/json" },
          });
          handleErrors(response);
          //          console.log("respgenerateMap:", response);
        } catch (err) {
          console.log(err);
          throw new Error(err.message);
        }
        while (body.firstChild) {
          body.removeChild(body.firstChild);
        }
        let elem = document.createElement("img");
        elem.setAttribute(
          "src",
          "images/background_and_menus/site_loading_loading.svg"
        );
        body.appendChild(elem);

        checkJobStatus(repo);
        setInterval(() => {
          checkJobStatus(repo);
        }, 10000); //every 10sec
      }

      async function checkJobStatus(postdata) {
        try {
          let response = await fetch("/api/mapStatus", {
            method: "POST",
            body: JSON.stringify(postdata),
            headers: { "Content-type": "application/json" },
          }); //just for example
          handleErrors(response);
          let job = await response.json();
          //          console.log("resp:", response);
          if (job.complete) {
            window.location.href = job.mapPageURL;
          }
        } catch (err) {
          console.log(err);
          throw new Error(err.message);
        }
      }

      //function to handle errors in ajax fetch
      function handleErrors(response) {
        if (!response.ok) {
          console.log(response.statusText);
          throw new Error(response.statusText);
        }
        return response;
      }
      function validateInput() {
        let err = "";
        let input = document.getElementById("inputField").value;
        let slashPos = input.indexOf("/");
        if (slashPos > 1) {
          let urlparts = input.split("/");
          if (
            urlparts.length != 5 ||
            urlparts[0] != "https:" ||
            urlparts[2].indexOf("git") < 0
          ) {
            err = "Wrong repo URL!";
          }
        } else {
          err = "Wrong repo URL!";
        }
        if (err) {
          let elem = document.getElementById("error");
          if (window.getComputedStyle(elem, null).display === "none") {
            elem.style.display = "block";
            document.getElementById("error").innerText = err;
          } else {
            elem.style.display = "none";
          }
        }
        if (err) {
          return false;
        } else {
          return true;
        }
      }
    </script>
  </body>
</html>
