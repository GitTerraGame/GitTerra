<html>
    <head>
        <style>
            .grid-container {
              display: grid;
              grid-template-columns: auto auto auto;
              padding: 0px;
            }
            .grid-item {
              border: 1px solid rgba(0, 0, 0, 0.8);
              padding: 0px;
              font-size: 10px;
              text-align: center;
            }
        </style>            
    </head>
    <body>
        <div>
            <label for="git">Enter git</label><br>
            <input type="text" id="git" name="git">
            <input type="submit" value="Submit" onclick="chekinput()">
        </div>
        <div id="owner">Owner: </div>
        <div id="repo">Repo: </div>
        <div id="lines">Lines: </div>
        <div id="size">Size (in KB): </div>
        <div id="files">Files: </div>
        <div style="color:red" id="error"></div>
        <br/>
        <div class="grid-container">
            <div class="grid-item" id="1">1</div>
            <div class="grid-item" id="2">2</div>
            <div class="grid-item" id="3">3</div>  
            <div class="grid-item" id="4">4</div>
            <div class="grid-item" id="5">5</div>
            <div class="grid-item" id="6">6</div>  
            <div class="grid-item" id="7">7</div>
            <div class="grid-item" id="8">8</div>
            <div class="grid-item" id="9">9</div>  
          </div>
          <script>
            const regexHTTPS = /^https:\/\/github\.com\/(.+?)\/(.+?)\.git$/;
            const regexSSH = /^git@github\.com:(.+?)\/(.+?)\.git$/;
            const regexURL = /^https:\/\/github\.com\/(.+?)\/(.+?)$/;
            let repo = '';
            let owner = '';

            async function chekinput(){
                'use strict';
                let error = false;
                let gitType = '';
                document.getElementById("error").innerHTML = '';
                let gitname =  document.getElementById("git").value.trim();
                if (!isGit(gitname) ) {
                    error = "wrong git format";
                }
                let gittype = getGitType(gitname);
                [owner, repo] = gitExrtact(gitname, gittype);
                document.getElementById("repo").innerHTML += repo;
                document.getElementById("owner").innerHTML += owner;

                let lines = await countLinesGithub(owner,repo);
                document.getElementById("lines").innerHTML += lines;
                let logOfLines = Math.round(Math.log(lines));
                console.log("logOfLines:",logOfLines);
                for (var i=1; i<logOfLines+1; i++) {
                    document.getElementById(i).style.background = "red";
                }
                let lines1 = await countLinesGithub1(owner,repo);
                let repoSize = await getRepoSize(owner, repo);
                document.getElementById("size").innerHTML += repoSize;

                let repoFiles = await countFilesGithub(owner, repo);
                document.getElementById("files").innerHTML += repoFiles;
                if (error) {
                    document.getElementById("error").innerHTML = error;
                }
            }
            function isGit(gitname) {
                if ( (regexHTTPS.test(gitname)) || (regexSSH.test(gitname))  || (regexURL.test(gitname)) ){
                    return true;
                }
                else {
                    return false;
                }
            }
            function getGitType(gitname) {
                if (regexHTTPS.test(gitname)) {
                    return 'HTTPS';
                }
                else if (regexSSH.test(gitname)) {
                    return 'SSH';
                }
                else if (regexURL.test(gitname)) {
                    return 'URL';
                }
            }
            function gitExrtact(gitname, gittype) {
                let match = [];
                if (gittype === 'HTTPS') {
                    match = gitname.match(regexHTTPS);
                }
                else if (gittype === 'SSH') {
                    match = gitname.match(regexSSH);
                }
                else if (gittype === 'URL') {
                    match = gitname.match(regexURL);
                }
                repo = match[2];
                owner = match[1];
                return [owner, repo];
            }
            async function countLinesGithub(owner, repo) {
                //modified from https://stackoverflow.com/questions/26881441/can-you-get-the-number-of-lines-of-code-from-a-github-repository/29012789#29012789
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/stats/contributors`)
                const contributors = await response.json();
                if ((response.status > 200) || (!contributors?.length)) {
                    return error = "Not found or empty array";
                }
//                console.log("contributors",contributors);
                const lineCounts = contributors.map(contributor => (
                    contributor.weeks.reduce((lineCount, week) => lineCount + week.a - week.d, 0)
                ));
//                console.log("lineCounts", lineCounts);
                const lines = lineCounts.reduce((lineTotal, lineCount) => lineTotal + lineCount);
                    console.log("lines", lines);
                return lines;
            }
            async function countLinesGithub1(owner, repo) {
                //modified from https://stackoverflow.com/questions/26881441/can-you-get-the-number-of-lines-of-code-from-a-github-repository/29012789#29012789
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/stats/code_frequency`)
                const res = await response.json();
                if (response.status > 200) {
                    return error = "Not found";
                }
//                console.log("contributors",contributors);
                const lines1 = res.reduce((total,changes)=>total+changes[1]+changes[2],0);
                console.log("lines1",lines1)
                return lines1;
            }
            
            async function getRepoSize(owner, repo) {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`)
                const json = await response.json();
                let size = json.size;
                if (response.status == 202) {
                    //repeat request? countLinesGithub(owner, repo);
                    //return;
                }
                if ((response.status > 200)) {
                    return error = "Not found";
                }
                return size;
            }
            /* count files and directories*/
            async function countFilesGithub(owner, repo) {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/master`)
                const resp = await response.json();
                /* to count only files, witout directories  - comment previous line and uncomment others
                let files = 0;
                for (var i=0; i<resp.tree.length; i++) {
                    if (resp.tree[i].type === 'blob') {
                        files++;
                    }
                }
                */
                if (response.status == 202) {
                    //repeat request? countLinesGithub(owner, repo);
                    //return;
                }
                else if (response.status > 200) {
                    return error = "Not found";
                }
                else {
                    let files = resp.tree.length;
                }
                return files;
            }

        </script>
    </body>
</html>